'use strict';

const SafeEnviroment = require('./lib/environment');
const utils = require('./lib/nunjucks-no-chokidar/src/lib');
const newUtils = require('./lib/utils');
const newParser = require('./lib/parser');
const nunjucks = require('./lib/nunjucks-no-chokidar');

// replace the `Environment`
nunjucks.OriginEnvironment = nunjucks.Environment;
nunjucks.Environment = SafeEnviroment;

// replace the parser
nunjucks.parser = newParser;

// monkey patch 内置的实现，例如 escape 被替换成更高性能的 escape-html
for (let key in newUtils) {
  utils[key] = newUtils[key];
}

// exports nunjucks inner modules.
nunjucks.nodes = require('./lib/nunjucks-no-chokidar/src/nodes');
nunjucks.transformer = require('./lib/nunjucks-no-chokidar/src/transformer');
nunjucks.utils = utils;

nunjucks.extensions = {
  require: require('./lib/tag-require'),
};

nunjucks.filters = require('./lib/nunjucks-no-chokidar/src/filters');

module.exports = nunjucks;
