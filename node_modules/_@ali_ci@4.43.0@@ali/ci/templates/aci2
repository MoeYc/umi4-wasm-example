# 不要修改该文件，会自动生成，详见 https://gitlab.alibaba-inc.com/node/ci
version: "2.0"
{%- set prefix="{{" %}
{%- set endfix="}}" %}
{%- macro stageNameFormater(type) -%}
{%- if item.name == "engines" -%}
{{type}}
{%- else -%}
{{type}}-{{item.name}}-{{item.version}}
{%- endif -%}
{%- endmacro -%}
{%- macro jobNameFormater(type) -%}
{{type}}-{{item.name}}-{{item.version}}
{%- endmacro -%}
{%- macro jobIDFormater(type) -%}
{{type}}-{{item.name}}-{{item.version}}
{%- endmacro -%}
{%- macro restoreKeyFormater(type) -%}
${{prefix}}jobs.{{type}}-{{item.name}}-{{item.version}}.outputs.cacheKey{{endfix}}
{%- endmacro %}
{%- set regExp = r/^test.*/ %}

parameters:
{%- if environments %}
  {%- for key, value in environments %}
  {{key}}: "{{value}}"
  {%- endfor %}
{%- endif %}

stages:
{%- for item in versions %}
{%- if stages and stages.build %}
  - {{stageNameFormater(type="build")}}
{%- endif %}
{%- if stages and stages.lint %}
  - {{stageNameFormater(type="lint")}}
{%- endif %}
{%- if stages and stages.run %}
  - {{stageNameFormater(type="run")}}
{%- endif %}
{%- if stages and stages.after %}
  - {{stageNameFormater(type="after")}}
{%- endif %}
{% endfor %}
jobs:
{%- for item in versions %}
  {%- if stages and stages.build %}
    {%- for value in stages.build %}
      {%- if value == "proxy" or value.job == "proxy" %}
  {{jobNameFormater(type="proxy")}}:
    stage: {{stageNameFormater(type="build")}}
    component: node-build
    id: {{jobIDFormater(type="proxy")}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
      buildType: proxy
        {%- if value.script %}
      proxyScript: {{value.script}}
        {%- endif %}
      {%- endif %}
      {%- if value == "mobilegw" or value.job == "mobilegw" %}
  {{jobNameFormater(type="mobilegw")}}:
    stage: {{stageNameFormater(type="build")}}
    component: node-build
    id: {{jobIDFormater(type="mobilegw")}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
      buildType: mobilegw
        {%- if value.script %}
      mobilegwScript: {{value.script}}
        {%- endif %}
      {%- endif %}
      {%- if value == "fengdie" or value.job == "fengdie" %}
  {{jobNameFormater(type="fengdie")}}:
    stage: {{stageNameFormater(type="build")}}
    component: node-build
    id: {{jobIDFormater(type="fengdie")}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
      buildType: fengdie
        {%- if value.script %}
      fengdieScript: {{value.script}}
        {%- endif %}
      {%- endif %}
      {%- if value == "application" or value.job == "application" %}
  {{jobNameFormater(type="application")}}:
    stage: {{stageNameFormater(type="build")}}
    component: node-build
    id: {{jobIDFormater(type="application")}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
      buildType: application
        {%- if value.script %}
      applicationScript: {{value.script}}
        {%- endif %}
      {%- endif %}
    {%- endfor %}
  {%- endif %}

  {%- if stages and stages.lint %}
    {%- for value in stages.lint %}
  {{value.job if value.job else value}}-{{item.name}}-{{item.version}}:
    stage: {{stageNameFormater(type="lint")}}
    component: node-lint
    id: {{value.job if value.job else value}}-{{item.name}}-{{item.version}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
      {%- if value.script %}
      script: {{value.script}}
      {%- else %}
      script: tnpm run {{value}}
      {%- endif %}
    {%- endfor %}
  {%- endif %}

  {%- if stages and stages.run %}
    {%- for value in stages.run %}
  {{value.job if value.job else value}}-{{item.name}}-{{item.version}}:
    stage: {{stageNameFormater(type="run")}}
    component: node-test
    id: {{value.job if value.job else value}}-{{item.name}}-{{item.version}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
      {%- if regExp.test(value) or regExp.test(value.job) %}
      jobSha: {{value.job if value.job else value}}-{{item.name}}-{{item.version}}-${{prefix}}vcs.commitSha{{endfix}}
      {%- endif %}
      {%- if stages and stages.build %}
        {%- for value in stages.build %}
          {%- if value == "proxy" or value.job == "proxy" %}
      proxyRestoreKey: {{restoreKeyFormater(type="proxy")}}
          {%- endif %}
          {%- if value == "mobilegw" or value.job == "mobilegw" %}
      mobilegwRestoreKey: {{restoreKeyFormater(type="mobilegw")}}
          {%- endif %}
          {%- if value == "fengdie" or value.job == "fengdie" %}
      fengdieRestoreKey: {{restoreKeyFormater(type="fengdie")}}
          {%- endif %}
          {%- if value == "application" or value.job == "application" %}
      applicationRestoreKey: {{restoreKeyFormater(type="application")}}
          {%- endif %}
        {%- endfor %}
      {%- endif %}
      {%- if value.script %}
      script: {{value.script}}
      {%- else %}
      script: tnpm run {{value}}
      {%- endif %}
      {%- if environments and environments.MYSQL_DATABASE %}
      MYSQL_DATABASE: {{environments.MYSQL_DATABASE}}
      {%- endif %}
      {%- if tengine %}
      tengine: "true"
      {%- endif %}
      {%- if obproxy %}
      obproxy: "true"
      {%- endif %}
      {%- if coverage == false %}
      coverage: "false"
      {%- endif %}
      {%- if coverage == true and check-coverage %}
      check-coverage: {{check-coverage}}
      {%- endif %}
    {%- endfor %}
  {%- endif %}

  {%- if stages and stages.after %}
    {%- for value in stages.after %}
      {%- if value == "coverage" or value.job == "coverage" %}
  {{jobNameFormater(type="coverage")}}:
    stage: {{stageNameFormater(type="after")}}
    component: node-coverage
    id: {{jobIDFormater(type="coverage")}}
    inputs:
      resourceClass: {{resourceClass}}
      nodeVersion: {{item.name}}={{item.version}}
        {%- if stages and stages.run %}
          {%- for value in stages.run %}
            {%- if regExp.test(value) or regExp.test(value.job) %}
      coverage-{{loop.index0}}-key: ${{prefix}}jobs.{{value.job if value.job else value}}-{{item.name}}-{{item.version}}.outputs.coverageKey{{endfix}}
            {%- endif %}
          {%- endfor %}
        {%- endif %}
        {%- if value.script %}
      script: {{value.script}}
        {%- endif %}
      {%- endif %}
    {%- endfor %}
  {%- endif %}
{% endfor %}
workflow:
  stages:
{%- for item in versions %}
  {%- if stages and stages.build and stages.run %}
    {{stageNameFormater(type="run")}}:
      requires:
        - {{stageNameFormater(type="build")}}
  {%- elif stages and stages.run %}
    {{stageNameFormater(type="run")}}:
  {%- endif %}
  {%- if stages and stages.lint %}
    {{stageNameFormater(type="lint")}}:
  {%- endif %}
  {%- if stages and stages.after %}
    {{stageNameFormater(type="after")}}:
      requires:
        - {{stageNameFormater(type="run")}}
  {%- endif %}
{% endfor %}