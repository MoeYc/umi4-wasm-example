# 不要修改该文件，会自动生成，详见 https://gitlab.alibaba-inc.com/node/ci

stage:
{%- for item in versions %}
  prepare_{{item.name}}_{{item.version}}:
    env:
      setting: {}
      lang: NODEJS
      image: {{image}}
    plugin:
      -
        param:
          url: '${repo}'
          branch: '${branch}'
          path: '${source_root}'
        name: checkout
        pos: front
    exec:
      - time curl -v -L -o- https://bash-scripts.antfin-inc.com/install-tnpm-standalone.js | bash
      - $HOME/.npm_global/tnpm/bin/tnpm i --install-{{item.name}}={{item.version}} --no-cache
  unit_test_{{item.name}}_{{item.version}}:
    env:
      setting: {}
      load: prepare_{{item.name}}_{{item.version}}
    plugin: []
    exec:
      - "CI_BUILD_REF=$source_version CI_BUILD_REF_NAME=$scm_branch CI_BUILD_REPO=$scm_url CI_BUILD_URL=http://cise.alibaba-inc.com/task/$task_id/build/$build_idx node_modules/.bin/tnpm run {{command}}"
{%- else %}
  prepare:
    env:
      setting: {}
      lang: NODEJS
      image: {{image}}
    plugin:
      -
        param:
          url: '${repo}'
          branch: '${branch}'
          path: '${source_root}'
        name: checkout
        pos: front
    exec:
      - time curl -v -L -o- https://bash-scripts.antfin-inc.com/install-tnpm-standalone.js | bash
      - $HOME/.npm_global/tnpm/bin/tnpm i --no-cache
  unit_test:
    env:
      setting: {}
      load: prepare
    plugin: []
    exec:
      - "CI_BUILD_REF=$source_version CI_BUILD_REF_NAME=$scm_branch CI_BUILD_REPO=$scm_url CI_BUILD_URL=http://cise.alibaba-inc.com/task/$task_id/build/$build_idx $HOME/.npm_global/tnpm/bin/tnpm run {{command}}"
{%- endfor %}

pipeline:
{%- for pl in pipeline %}
  - '{{pl}}'
{%- else %}
  - prepare
  - unit_test
{%- endfor %}
